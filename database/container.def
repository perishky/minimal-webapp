Bootstrap: docker
From: mysql:8.0-debian

%files
    init.sql /data/init.sql
    custom.cnf /etc/mysql/conf.d/custom.cnf
    
%post
    mkdir -p /data/mysql
    mkdir -p /var/run/mysqld
    
    apt-get update
    apt-get install gettext-base

%startscript 
    : "${DB_ROOT_PASSWORD:?database root password must be provided via --env-file}"
    : "${DB_HOST:?database hostname must be provided via --env-file}"
    : "${DB_NAME:?database identifier must be provided via --env-file}"
    : "${DB_USER:?database user name must be provided via --env-file}"
    : "${DB_PASSWORD:?database password must be provided via --env-file}"

    rm -f /tmp/mysql.sock /tmp/mysql.sock.lock
    rm -f /tmp/mysqlx.sock /tmp/mysqlx.sock.lock

    if [ ! -d "/data/mysql/mysql" ]; then
        echo "Initializing database..."	
        mysqld --initialize-insecure --user=mysql
	mysqld --user=mysql &
        MYSQL_PID=$!
        sleep 10
        mysql -u root <<EOF
            $(envsubst < /data/init.sql)
EOF
        kill $MYSQL_PID
        wait $MYSQL_PID
    fi

    exec mysqld --user=mysql 
