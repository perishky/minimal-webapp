Bootstrap: docker
From: mysql:8.0

%files
    init.sql /tmp/init.sql

%post
    mkdir -p /data/mysql
    
%startscript 
    : "${DB_ROOT_PASSWORD:?database root password must be provided via --env-file}"
    : "${DB_NAME:?database identifier must be provided via --env-file}"
    : "${DB_USER:?database user name must be provided via --env-file}"
    : "${DB_PASSWORD:?database password must be provided via --env-file}"

    if [ ! -d "/data/mysql/mysql" ]; then
        echo "Initializing database..."	
        mysqld --initialize-insecure --user=mysql --datadir=/data/mysql

        echo "Waiting for MySQL to wake up..."
        until mysqladmin ping -h localhost --silent; do
            sleep 2
        done

	echo "Setting up database ..."
        mysql -u root <<EOF
            $(envsubst < /tmp/init.sql)
        EOF
    fi

    exec mysqld \
        --datadir=/data/mysql \
        --user=mysql \
        --bind-address=0.0.0.0 \
        --port=${DB_PORT} 
